name: ğŸš€ Deploy Ultimate Hyperfocus Constellation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Update repository data weekly
    - cron: '0 0 * * 0'

jobs:
  accessibility-test:
    name: â™¿ Accessibility Testing
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run accessibility tests
      run: npm run test:a11y

    - name: ğŸ“Š Lighthouse accessibility audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: '.lighthouserc.json'

  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Install dependencies  
      run: npm ci

    - name: âš¡ Run performance tests
      run: npm run test:performance

    - name: ğŸ“ˆ Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: lighthouse-results/

  build-and-deploy:
    name: ğŸŒŸ Build and Deploy
    runs-on: ubuntu-latest
    needs: [accessibility-test, performance-test]

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build project
      run: npm run build

    - name: ğŸ§ª Validate HTML
      run: npm run validate

    - name: ğŸŒ Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        commit_message: 'ğŸš€ Deploy Ultimate Hyperfocus Constellation'

    - name: ğŸ“¢ Create deployment summary
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸŒŸ **Ultimate Hyperfocus Constellation Deployed!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ **Live Demo**: https://welshdog.github.io/ultimate-hyperfocus-constellation/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Accessibility**: WCAG 2.1 AA Compliant" >> $GITHUB_STEP_SUMMARY
        echo "âš¡ **Performance**: Optimized for 60 FPS" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“± **Mobile**: Touch-optimized controls" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ§  **Neurodivergent**: ADHD-friendly interface" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run security audit
      run: npm audit --audit-level high

    - name: ğŸ›¡ï¸ CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: javascript

    - name: ğŸ”¬ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
